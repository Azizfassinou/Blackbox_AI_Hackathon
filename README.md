# Blackbox AI PR Review Bot

An intelligent GitHub Actions bot that provides comprehensive code reviews using Blackbox AI and specialized analyzers. The bot now includes enhanced diff analysis and provides detailed summaries of code changes.

## ✨ New Features

### Enhanced Code Review with Diff Analysis
- **Diff-aware analysis**: Focuses review on changed code sections
- **Visual diff display**: Shows code changes in comments  
- **Complexity assessment**: Evaluates change complexity (low/medium/high)
- **Change-focused feedback**: Prioritizes issues in modified areas

### Improved Summary Comments
- **Code quality grading**: A-F grade for overall code quality
- **Change overview**: Lines added/removed and complexity metrics
- **Priority issues**: Highlights problems in changed code with 🔄 marker
- **Recommendations**: Actionable suggestions based on findings

## 🚀 Quick Start

### 1. Repository Setup

Add these files to your repository:

```bash
mkdir -p .github/workflows
# Copy the workflow file (already provided)
```

### 2. Required Secrets

Configure these secrets in your GitHub repository:

```bash
# GitHub Settings > Secrets and variables > Actions
BLACKBOX_API_KEY=your_blackbox_api_key_here
# GITHUB_TOKEN is provided automatically by GitHub Actions
```

### 3. Configuration (Optional)

Create `.pr-review-bot.json` in your repository root:

```json
{
  "enabled": true,
  "auto_comment": true,
  "severity_threshold": "low",
  "ignore_patterns": ["*.md", "*.txt", "package-lock.json", "yarn.lock"],
  "features": {
    "bug_detection": true,
    "security_scan": true,
    "doc_linking": true,
    "summarization": true
  },
  "max_comments": 50
}
```

## 🎯 How It Works

### 1. Trigger
The bot activates on:
- New pull requests
- PR updates (synchronize)
- PR reopening

### 2. Analysis Process
1. **Diff Analysis**: Parses git diffs to identify changed lines and code sections
2. **Blackbox AI Review**: Sends code with diff context for intelligent analysis
3. **Local Analyzers**: Pattern-based security and bug detection
4. **Documentation Linking**: Finds relevant docs for issues

### 3. Results
- **Inline Comments**: Posted on specific lines with issues
- **Summary Comment**: Comprehensive overview with:
  - Code quality grade
  - Change statistics (lines added/removed)
  - Issue breakdown by severity
  - Files with significant changes
  - Priority recommendations

## 📋 Sample Review Output

### Summary Comment Example:

```markdown
## 🤖 Blackbox AI Code Review Summary

**Status:** ⚡ Minor issues found - consider addressing
**Code Quality:** B grade

### 📊 Changes Overview
- **Files changed:** 5
- **Lines added:** +127
- **Lines removed:** -43
- **Change complexity:** medium

**Files with significant changes:**
- `src/main.py` (+89/-12)
- `src/analyzers/security.py` (+38/-31)

### 🔍 Review Results
- **Total issues found:** 8
- **Files with issues:** 3

**Issues by severity:**
- ⚠️ High: 1
- ⚡ Medium: 3
- ℹ️ Low: 4

### ⚠️ Priority Issues
1. ⚠️ **src/main.py:45** 🔄 - Potential SQL injection vulnerability
2. ⚡ **src/utils.py:123** - Unused variable detected
3. ℹ️ **src/config.py:67** 🔄 - Consider using environment variables

### 💡 Code Quality Insights
**Main areas for improvement:**
- Input validation and sanitization
- Error handling consistency
- Code documentation coverage

### 📋 Recommendations
⚠️ **High Priority:** Review and fix high-severity issues
🔍 **Review:** Check inline comments for detailed feedback and suggestions

---
*💻 Detailed feedback available in inline comments*  
*🔄 Issues marked with 🔄 are in changed code sections*  
*🤖 Generated by Blackbox AI PR Review Bot*
```

### Inline Comment Example:

```markdown
🔒 **Security** 🚨 *Critical Severity*

SQL query constructed with user input without proper sanitization

**Code:**
```python
query = f"SELECT * FROM users WHERE id = {user_id}"
```

**💡 Suggestion:**
Use parameterized queries to prevent SQL injection:
```python
query = "SELECT * FROM users WHERE id = %s"
cursor.execute(query, (user_id,))
```

**🔗 Reference:** [CWE-89](https://cwe.mitre.org/data/definitions/89.html)

---
*🤖 Generated by Blackbox AI PR Review Bot*
```

## 🔧 Implementation Details

### Key Components

1. **main.py**: Orchestrates the entire review process
2. **diff_parser.py**: Parses git diffs and extracts change information
3. **comment_formatter.py**: Formats review comments with diff context
4. **github_client.py**: Handles GitHub API interactions
5. **blackbox_client.py**: Interfaces with Blackbox AI API
6. **analyzers/**: Local analysis modules (security, bugs, etc.)

### Enhanced Features

#### Diff-Aware Analysis
```python
# Example of diff information passed to analyzers
diff_info = {
    "changed_lines": [{"line": 45, "type": "addition"}],
    "additions": 15,
    "deletions": 3,
    "snippets": [{"start_line": 40, "content": "..."}],
    "complexity": "medium",
    "is_significant": True
}
```

#### Smart Issue Prioritization
- Issues in changed code marked with 🔄
- Severity-based sorting (critical → info)
- Change complexity affects recommendations

## 🛠️ Development

### Local Testing

```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables
export GITHUB_TOKEN="your_token"
export BLACKBOX_API_KEY="your_key"
export PR_NUMBER="123"
export REPO_NAME="owner/repo"

# Run locally
python src/main.py
```

### Testing Individual Components

```bash
# Test diff parser
python -m pytest tests/test_diff_parser.py

# Test analyzers
python -m pytest tests/test_analyzers.py

# Test comment formatting  
python -m pytest tests/test_comment_formatter.py
```

## 📈 Performance

### Metrics
- **Analysis Speed**: ~30-60 seconds per PR
- **API Limits**: Respects GitHub rate limits
- **Comment Limits**: Max 50 comments per PR (configurable)

### Optimization Tips
- Adjust `severity_threshold` to reduce noise
- Use `ignore_patterns` for non-critical files
- Set `max_comments` based on your workflow

## 🔐 Security

### Best Practices
- Store API keys as GitHub Secrets
- Use minimal GitHub token permissions
- Review bot suggestions before merging
- Regularly update dependencies

### Required Permissions
```yaml
permissions:
  contents: read
  pull-requests: write
  issues: write
```

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Update documentation
5. Submit a pull request

## 📄 License

MIT License - see LICENSE file for details

## 🆘 Troubleshooting

### Common Issues

#### Bot Not Triggering
- Check webhook configuration
- Verify required secrets are set
- Review workflow permissions

#### API Rate Limits
- Reduce comment frequency
- Implement retry logic
- Use GitHub Apps for higher limits

#### Poor Review Quality
- Adjust severity thresholds
- Update ignore patterns
- Fine-tune analyzer configurations

### Debug Mode
Enable debug logging by setting:
```yaml
env:
  DEBUG: "true"
```

## 🔗 Related Links

- [Blackbox AI API Documentation](https://www.blackbox.ai/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitHub REST API](https://docs.github.com/en/rest)

---

**Made with ❤️ by the Blackbox AI community**
